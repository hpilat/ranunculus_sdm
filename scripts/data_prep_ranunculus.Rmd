---
title: "data_prep_ranunculus"
author: "Hannah Pilat"
date: "2024-01-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document processes the occurrence and predictor data (previously downloaded in data_download_ranunculus.Rmd) to have matching extents, resolutions, and Coordinate Reference Systems.

General flow: (may not need to perform all steps for each object)
- Ensure objects are in SpatRaster format
- Reproject SpatRasters to WGS84
- Resample SpatRasters to 800m resolution (1km at the equator, reads out as 0.008333)
- Crop SpatRasters to na_bound (our study extent)

The code from line 344 above should run. Below that is a work in progress. 

### **Spatial Extent**

Our spatial extent covers the western side of North America: from the Pacific Coast to the Great Continental Divide. The extent was created in continental_divide.Rmd. 
Here, we'll turn the resultant shapefile from continental_divide.Rmd into a SpatVector, to be used as our extent for cropping the *Ranunculus* occurrence vector and the predictor SpatRasters.
```{r, echo = FALSE}
na_bound <- read_sf("data/raw/continental_divide_buffer_boundary.shp")
na_bound <- vect(na_bound)
```

### **Occurrence Records**
Select only the relevant columns from the *Ranunculus* occurrence dataframe: (ID column, longitude, latitude)

```{r, echo = FALSE}
ran_occ <- dplyr::select(ran_occ_download, gbifID, 
                         decimalLongitude, decimalLatitude) # dataframe
```
Create a SpatVector object for the occurrence data so we can crop its extent:
```{r, echo = FALSE}
ran_occ_vect <- vect(ran_occ, geom = c("decimalLongitude", "decimalLatitude"), 
                     crs = "EPSG:4326", keepgeom = FALSE)

ran_occ <- crop(ran_occ_vect, na_bound)
ran_occ
```
Create a Simple Features (sf) object from the ran_occ SpatVector, to be used in the TidySDM pipeline (later)
```{r, echo = FALSE}
ran_occ_sf <- st_as_sf(ran_occ, 
                       coords = c("decimalLongitude", "decimalLatitude"))
ran_occ_sf
```

### **Predictor Data**

List of predictors in alphabetical order:
- anth_biome
- climate_zones (troubleshooting)
- elevation_na
- lndcvr_na
- precip
- protect_area_IUCN
- protect_area_OECM
- soilphh2o_0_5
- soilphh2o_5_15
- soil_temp_0_5
- soil_temp_5_15
- temp_avg_mar_jun
- watersheds

Start with the predictors that came as .tif files/SpatRasters

#### Anthropogenic Biomes

Reproject anthropogenic biomes data to WGS84
```{r, echo = FALSE}
anth_biome <- project(anth_biome, "EPSG:4326")
```
Resample anth_biome to change resolution
```{r, echo = FALSE}
anth_biome <- resample(anth_biome, soil_temp_0_5)
```
Crop anth_biome to study extent
```{r, echo = FALSE}
anth_biome <- crop(anth_biome, na_bound)
```
Write anth_biome to file for faster computation
```{r, echo = FALSE}
anth_biome <- writeRaster(anth_biome, filename = "data/processed/anth_biome.tif")
```
Read in processed anth_biome raster
```{r, echo = FALSE}
anth_biome <- rast("data/processed/anth_biome.tif")
```

#### Elevation

Reproject elevation data to WGS84
```{r, echo = FALSE}
elevation_na <- terra::project(elevation_na, "EPSG:4326", method = "bilinear")
```
Resample elevation_na to change resolution
```{r, echo = FALSE}
elevation_na <- terra::resample(elevation_na, soil_temp_0_5)
```
Crop elevation data to study area extent
```{r, echo = FALSE}
elevation_na <- crop(elevation_na, na_bound)
```
Write elevation_na to file for easier reuse
```{r, echo = FALSE}
elevation_na <- writeRaster(elevation_na, filename = "data/processed/elevation_na.tif", 
                            overwrite = TRUE)
```
Read in elevation data
```{r, echo = FALSE}
elevation_na <- rast("data/processed/elevation_na.tif")
```

#### Landcover

Aggregate landcover data so it can be reprojected and cropped
```{r, echo = FALSE}
lndcvr_na_agg <- aggregate(lndcvr_na, fact = 15)
```
Write aggregated landcover data to file for easier reuse
```{r, echo = FALSE}
lndcvr_na_agg <-writeRaster(lndcvr_na_agg, 
                            filename = "data/processed/lndcvr-north-america_agg.tif", 
                            overwrite = TRUE)
```
Create SpatRaster of aggregated landcover data from new file
```{r, echo = FALSE}
lndcvr_na_agg <- rast("data/processed/lndcvr-north-america_agg.tif")
```
Reproject landcover North America data to WGS84
```{r, echo = FALSE}
lndcvr_na_agg <- terra::project(lndcvr_na_agg, "EPSG:4326", method = "near")
```
Crop landcover North America data to BC's extent
```{r, echo = FALSE}
lndcvr_na <- crop(lndcvr_na_agg, na_bound)
```
Resample landcover BC data to change resolution
```{r, echo = FALSE}
lndcvr_na <- resample(lndcvr_na, soil_temp_0_5)
```
Create file of processed landcover data for faster re-use
```{r, echo = FALSE}
lndcvr_na <- writeRaster(lndcvr_na, "data/processed/lndcvr_na.tif", overwrite = TRUE)
```
Import processed landcover data from new file created above
```{r, echo = FALSE}
lndcvr_na <- rast("data/processed/lndcvr_na.tif")
```

#### Precipitation

Resample precipitation data to change resolution
```{r, echo = FALSE}
precip_global <- resample(precip_global, soil_temp_0_5)
```
Crop precipitation data to British Columbia extent
```{r, echo = FALSE}
precip <- crop(precip_global, na_bound)
```
Write precipitation data to file for faster future computation
```{r, echo = FALSE}
precip <- writeRaster(precip, filename = "data/processed/precipitation.tif")
```
Read in precipitation data
```{r, echo = FALSE}
precip <- rast("data/processed/precipitation.tif")
```

#### Soil pH

Reproject soil pH SpatRasters to WGS84
```{r, echo = FALSE}
soil_phh2o_0_5 <- terra::project(soil_phh2o_0_5, "EPSG:4326",
                                 method = "bilinear")

soil_phh2o_5_15 <- terra::project(soil_phh2o_5_15, "EPSG:4326",
                                  method = "bilinear")
```
Crop pH SpatRaster to North American extent
```{r, echo = FALSE}
soil_phh2o_0_5 <- crop(soil_phh2o_0_5, na_bound)
soil_phh2o_5_15 <- crop(soil_phh2o_5_15, na_bound)
```

Write processed soil pH data to file for faster computation
```{r, echo = FALSE}
soil_phh2o_0_5 <- writeRaster(soil_phh2o_0_5, filename = "data/processed/soil_phh2o_0_5.tif")
soil_phh2o_5_15 <- writeRaster(soil_phh2o_5_15, filename = "data/processed/soil_phh2o_5_15.tif")
```

Read in soil pH data from file
```{r, echo = FALSE}
soil_phh2o_0_5 <- rast("data/processed/soil_phh2o_0_5.tif")
soil_phh2o_5_15 <- rast("data/processed/soil_phh2o_5_15.tif")
```

#### Soil Temperature

Crop soil temperature SpatRaster to North American extent
```{r, echo = FALSE}
soil_temp_0_5 <- crop(soil_temp_0_5, na_bound)
soil_temp_5_15 <- crop(soil_temp_5_15, na_bound)
```

Reproject soil temperature SpatRasters to WGS84
```{r, echo = FALSE}
soil_temp_0_5 <- terra::project(soil_temp_0_5, "EPSG:4326",
                                method = "bilinear")
soil_temp_5_15 <- terra::project(soil_temp_5_15, "EPSG:4326",
                                method = "bilinear")
```

Write processed data to file for faster computation
```{r, echo = FALSE}
soil_temp_0_5 <- writeRaster(soil_temp_0_5, filename = "data/processed/soil_temp_0_5.tif")
soil_temp_5_15 <- writeRaster(soil_temp_5_15, filename = "data/processed/soil_temp_5_15cm.tif")
```

Read in soil temperature data from file:
```{r, echo = FALSE}
soil_temp_0_5 <- rast("data/processed/soil_temp_0_5.tif")
soil_temp_5_15 <- rast("data/processed/soil_temp_5_15.tif")
```

#### Temperature, monthly averages

Select March to June for average temperatures (relevant to growing season)
```{r, echo = FALSE}
tavg_mar_jun <- temp_avg_global[[3:6]]
```
Reproject temp data to WGS84
```{r, echo = FALSE}
tavg_mar_jun <- project(tavg_mar_jun, "EPSG:4326", method = "bilinear")
```
Resample temperature data to change resolution
```{r, echo = FALSE}
tavg_mar_jun <- resample(tavg_mar_jun, soil_temp_0_5)
```
Crop temperature data to match North America extent
```{r, echo = FALSE}
tavg_mar_jun <- crop(tavg_mar_jun, na_bound)
```
Write temperature data to file for faster future computation
```{r, echo = FALSE}
tavg_mar_jun <- writeRaster(tavg_mar_jun, filename = "data/processed/tavg_mar_jun.tif")
```
Read in temperature data
```{r, echo = FALSE}
tavg_mar_jun <- rast("data/processed/tavg_mar_jun.tif")
```

#### **Shapefile/SpatVector transformations**

Will need an empty raster template for rasterizing shapefiles (currently vector objects) 
Create a temporary raster with number of columns and rows from other rasters
```{r, echo = FALSE}
dim(lndcvr_na)
temprast <- rast(climate_zones_vect, ncols = 12247, nrows = 8024)
```

#### Climate Zones

Create raster from SpatVector and structure of temporary raster
```{r, echo = TRUE}
climate_zones <- rasterize(climate_zones_vect, temprast, field = "Climate")
plot(climate_zones)
```
Need to reproject to WGS84 in order to resample and crop
```{r, echo = FALSE}
climate_zones <- project(climate_zones, "EPSG:4326")
climate_zones<- resample(climate_zones, lndcvr_na)
climate_zones <- crop(climate_zones, na_bound)
```
Write to file for faster computation
```{r, echo = FALSE}
climate_zones <- writeRaster(climate_zones, filename = "data/processed/climate_zones.tif")
```
Read in climate_zones data from file
```{r, echo = FALSE}
climate_zones <- rast("data/processed/climate_zones.tif")
```

#### Protected Areas:  IUCN Categories 

Repeat above steps used for climate_zones
```{r, echo = TRUE}
protect_area_IUCN <- rasterize(protect_area_IUCN_vect, temprast, field = "TYPE_PA")
protect_area_IUCN <- project(protect_area_IUCN, "EPSG:4326")
protect_area_IUCN <- resample(protect_area_IUCN, lndcvr_na)
protect_area_IUCN <- crop(protect_area_IUCN, na_bound)
plot(protect_area_IUCN)
```
Write to file for faster computation
```{r, echo = FALSE}
protect_area_IUCN <- writeRaster(protect_area_IUCN, 
                                 filename = "data/processed/protect_area_IUCN.tif")
```
Read in protected areas IUCN data from file
```{r, echo = FALSE}
protect_area_IUCN <- rast("data/processed/protect_area_IUCN.tif")
```

#### Protected Areas: OECMs

Repeat above steps used for climate_zones and protect_area_IUCN
```{r, echo = TRUE}
protect_area_OECM <- rasterize(protect_area_OECM_vect, temprast, field = "TYPE_PA")
protect_area_OECM <- project(protect_area_OECM, "EPSG:4326")
protect_area_OECM <- resample(protect_area_OECM, lndcvr_na)
protect_area_OECM <- crop(protect_area_OECM, na_bound)
plot(protect_area_OECM)
```
Write to file for faster computation
```{r, echo = FALSE}
protect_area_OECM <- writeRaster(protect_area_OECM, 
                                 filename = "data/processed/protect_area_OECM.tif")
```
Read in protected areas IUCN data from file
```{r, echo = FALSE}
protect_area_OECM <- rast("data/processed/protect_area_OECM.tif")
```

#### Watersheds

Repeat above steps for watershed data
```{r, echo = TRUE}
watersheds <- rasterize(watersheds_vect, temprast, field = "NAW4_EN")
watersheds <- project(watersheds, "EPSG:4326")
watersheds <- resample(watersheds, lndcvr_na)
watersheds <- crop(watersheds, na_bound)
plot(watersheds)
```
Write to file for faster computation
```{r, echo = FALSE}
watersheds <- writeRaster(watersheds, filename = "data/processed/watersheds.tif")
```
# read in watersheds data from file
```{r, echo = FALSE}
watersheds <- rast("data/processed/watersheds.tif")
```


Below this point is code that isn't quite working

#### Multilayer Raster

Create a multilayer raster of the predictor variables
```{r, echo = FALSE}
predictors_multirast <- rast(c(anth_biome,
                               climate_zones,
                               elevation_na,
                               lndcvr_na, 
                               precip, 
                               protect_area_IUCN, 
                               protect_area_OECM,
                               soil_phh2o_0_5,
                               soil_phh2o_5_15,
                               soil_temp_0_5, 
                               soil_temp_5_15,
                               tavg_mar_jun, 
                               watersheds))
```
Multiraster doesn't hold any values - likely need to remove NA values from individual predictor rasters

Mask all layers so values outside of na_bound are NA
```{r, echo = FALSE}
anth_biome <- mask(anth_biome, na_bound)
climate_zones <- mask(climate_zones, na_bound)
elevation_na <- mask(elevation_na, na_bound)
lndcvr_na <- mask(lndcvr_na, na_bound)
precip <- mask(precip, na_bound)
protect_area_IUCN <- mask(protect_area_IUCN, na_bound)
protect_area_OECM <- mask(protect_area_OECM, na_bound)
soil_phh2o_0_5 <- mask(soil_phh2o_0_5, na_bound)
soil_phh2o_5_15 <- mask(soil_phh2o_5_15, na_bound)
soil_temp_0_5 <- mask(soil_temp_0_5, na_bound)
soil_temp_5_15 <- mask(soil_temp_5_15, na_bound)
tavg_mar_jun <- mask(tavg_mar_jun, na_bound)
watersheds <- mask(watersheds, na_bound)
```
Set all NA values to -9999? (predictors cannot have NA values)
```{r, echo = FALSE}
anth_biome[is.na(anth_biome)] <- -9999
climate_zones[is.na(climate_zones)] <- -9999
elevation_na[is.na(elevation_na)] <- -9999
lndcvr_na[is.na(lndcvr_na)] <- -9999
precip[is.na(precip)] <- -9999
protect_area_IUCN[is.na(protect_area_IUCN)] <- -9999
protect_area_OECM[is.na(protect_area_OECM)] <- -9999
soil_phh2o_0_5[is.na(soil_phh2o_5_15)] <- -9999
soil_phh2o_5_15[is.na(soil_phh2o_5_15)] <- -9999
soil_temp_0_5[is.na(soil_temp_0_5)] <- -9999
soil_temp_5_15[is.na(soil_temp_5_15)] <- -9999
tavg_mar_jun[is.na(tavg_mar_jun)] <- -9999
watersheds[is.na(watersheds)] <- -9999
```
Since there are multiple layers in precip and tavg_mar_jun, might need to use below code:
precip:
```{r, echo = FALSE}
for(i in 1:12){
  precip[is.na(precip[,,i])] <- -9999
}
```
tavg_mar_jun:
```{r, echo = FALSE}
for(i in 1:4){
  tavg_mar_jun[is.na(tavg_mar_jun[,,i])] <- -9999
}
```
Try making a multilayer raster again
```{r, echo = FALSE}
predictors_multirast <- rast(c(anth_biome,
                               climate_zones,
                               elevation_na,
                               lndcvr_na, 
                               precip, 
                               protect_area_IUCN, 
                               protect_area_OECM,
                               soil_phh2o_0_5,
                               soil_phh2o_5_15,
                               soil_temp_0_5, 
                               soil_temp_5_15,
                               tavg_mar_jun, 
                               watersheds))
```
Can also try: mask(r, !is.na(r)), where r is the SpatRaster object

Could also mask initially with -9999 added to cells outside of na_bound:
```{r, echo = FALSE}
anth_biome <- mask(anth_biome, na_bound, updatevalue = -9999)
elevation_na <- mask(elevation_na, na_bound, updatevalue = -9999)
lndcvr_na <- mask(lndcvr_na, na_bound, updatevalue = -9999)
precip <- mask(precip, na_bound, updatevalue = -9999)
soil_phh2o_0_5 <- mask(soil_phh2o_0_5, na_bound, updatevalue = -9999)
soil_phh2o_5_15 <- mask(soil_phh2o_5_15, na_bound, updatevalue = -9999)
soil_temp_0_5 <- mask(soil_temp_0_5, na_bound, updatevalue = -9999)
soil_temp_5_15 <- mask(soil_temp_5_15, na_bound, updatevalue = -9999)
tavg_mar_jun <- mask(tavg_mar_jun, na_bound, updatevalue = -9999)
watersheds <- mask(watersheds, na_bound, updatevalue = -9999)
```

OR: 
Use different values as the colour scale gets messed right up with -9999 (skewed heavily toward -9999)
```{r, echo = FALSE}
anth_biome[is.na(anth_biome)] <- -10
elevation_na[is.na(elevation_na)] <- -500
lndcvr_na[is.na(lndcvr_na)] <- -10
precip[is.na(precip)] <- -10
soil_phh2o_0_5[is.na(soil_phh2o_5_15)] <- -10
soil_phh2o_5_15[is.na(soil_phh2o_5_15)] <- -10
soil_temp_0_5[is.na(soil_temp_0_5)] <- -100
soil_temp_5_15[is.na(soil_temp_5_15)] <- -100
tavg_mar_jun[is.na(tavg_mar_jun)] <- -200
```

# trim NA values from outside of boundary
#### this might be where extents are shifting, probably won't use the below code ####

# anth_biome <- trim(anth_biome, padding = 0, value = NA)
# elevation_na <- trim(elevation_na, padding = 0, value = NA)
# lndcvr_na <- trim(lndcvr_na, padding = 0, value = NA)
# precip <- trim(precip, padding = 0, value = NA)
# soil_phh2o_0_5 <- trim(soil_phh2o_0_5, padding = 0, value = NA)
# soil_phh2o_5_15 <- trim(soil_phh2o_5_15, padding = 0, value = NA)
# soil_temp_0_5 <- trim(soil_temp_0_5, padding = 0, value = NA)
# soil_temp_5_15 <- trim(soil_temp_5_15, padding = 0, value = NA)
# tavg_mar_jun <- trim(tavg_mar_jun, padding = 0, value = NA)

# extents moved around a bit - need to crop to smallest extent (bc_bec or lndcvr_bc)
# elevation_bc <- crop(elevation_bc, bc_bound)
# soil_temp_0_5_bc <- crop(soil_temp_0_5_bc, bc_bound)
# soil_temp_5_15_bc <- crop(soil_temp_5_15_bc, bc_bound)
# soil_phh2o_0_5_bc <- crop(soil_phh2o_0_5_bc, bc_bound)
# soil_phh2o_5_15_bc <- crop(soil_phh2o_5_15_bc, bc_bound)
# prec_bc <- crop(prec_bc, bc_bound)
# tavg_bc <- crop(tavg_bc, bc_bound)
# lndcvr_bc <- crop(lndcvr_bc, bc_bound)


# write rasters to file for faster computation
# elevation_bc <- writeRaster(elevation_bc, filename = "data/elevation_bc.tif")
# soil_temp_0_5_bc <- writeRaster(soil_temp_0_5_bc, 
                                # filename = "data/soil_temp_0_5_bc.tif")
# soil_temp_5_15_bc <- writeRaster(soil_temp_5_15_bc, 
                                # filename = "data/soil_temp_5_15_bc.tif")
# soil_phh2o_0_5_bc <- writeRaster(soil_phh2o_0_5_bc, 
                                # filename = "data/soil_phh2o_0_5_bc.tif")
# soil_phh2o_5_15_bc <- writeRaster(soil_phh2o_5_15_bc,
                                # filename = "data/soil_phh2o_5_15_bc.tif")
# prec_bc <- writeRaster(prec_bc, filename = "data/prec_bc.tif")
# bc_bec <- writeRaster(bc_bec, filename = "data/bc_bec.tif", overwrite = TRUE)
# tavg_bc <- writeRaster(tavg_bc, filename = "data/tavg_bc.tif")
# lndcvr_bc <- writeRaster(lndcvr_bc, filename = "data/lndcvr_bc.tif", overwrite = TRUE)


